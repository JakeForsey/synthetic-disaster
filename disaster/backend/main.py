import io
from PIL import Image
import json

from flask_cors import CORS
from flask import Flask
from flask import Response
from werkzeug import FileWrapper
import torch
from torchvision import transforms
import numpy as np

from pix2pix import Generator
from bin.train_pix2pix import XView2Dataset
from bin.train_pix2pix import HEIGHT, WIDTH

app = Flask(__name__)
CORS(app)
generator = Generator()
generator.load_state_dict(
    torch.load('checkpoints/pix2pix_generator_20.pth', map_location=torch.device('cpu'))
)
generator.eval()

LABELS_JSON = """{"features": {"lng_lat": [{"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "0c170af0-8c1d-4482-8b78-c2f9467b6e08"}, "wkt": "POLYGON ((-77.88794342725502 34.55869085349028, -77.88790522578329 34.55872235157872, -77.88790031151468 34.55874732529674, -77.8878483530587 34.55878201721122, -77.88777464878538 34.55872257465175, -77.88777801367858 34.55871962683526, -77.88773885223929 34.55868996020622, -77.88773980867056 34.55868420124676, -77.88771364599538 34.55866283136822, -77.88775184751823 34.5586313333373, -77.88770704493973 34.55860562445034, -77.88770410785014 34.55858752897094, -77.88775603321538 34.55855188184918, -77.88776177352122 34.5585507899064, -77.88777793888934 34.55855040722356, -77.88783273875326 34.55859786863309, -77.88783075982282 34.55860747601129, -77.88783993109975 34.55860534678855, -77.88788734043007 34.55863959839004, -77.88788163316183 34.55864164560972, -77.88794342725502 34.55869085349028))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "0de0d6bb-53a2-4613-9c25-00cb789087cf"}, "wkt": "POLYGON ((-77.88393193841702 34.55845150206908, -77.88378875897936 34.55842142505739, -77.8838111262384 34.55833293929781, -77.88382036359978 34.55833272092229, -77.883957637554 34.55835911329952, -77.88395582335932 34.55840695889945, -77.88393193841702 34.55845150206908))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "07200cae-a9a0-4cdd-a410-3b5a0dc60fb8"}, "wkt": "POLYGON ((-77.88394127361261 34.5582533781524, -77.88387621620599 34.55824344353714, -77.88387717290325 34.55823768459456, -77.8838644055562 34.55823607431752, -77.88387031071869 34.55820629703317, -77.88387120142583 34.55819862754218, -77.88385955575812 34.55819603469274, -77.8838617661095 34.55819311427557, -77.88385595977351 34.55819229548762, -77.88386450406507 34.55813855445629, -77.88387819509848 34.55813345051727, -77.88388268178709 34.55812952023079, -77.88389172115366 34.55812357020579, -77.8839007935143 34.55811857545437, -77.88391224119893 34.55811543665532, -77.88391676088051 34.55811246164188, -77.88391893823223 34.55810858594968, -77.88391982893449 34.55810091645851, -77.88402892855873 34.55811459007975, -77.88402579452604 34.55812422471694, -77.88402853281931 34.55813658868241, -77.88403232679019 34.55814605952664, -77.88403377843002 34.55815462969441, -77.88403499909144 34.55815651294368, -77.88402444254532 34.55821890604573, -77.88394899314433 34.55820921715748, -77.88394127361261 34.5582533781524))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "4f1f4610-8d56-476f-8b2b-5bb99bc22c4f"}, "wkt": "POLYGON ((-77.88341768064025 34.55815007295751, -77.8831758932828 34.55810894121117, -77.88317450770558 34.55810228157828, -77.88315715470395 34.55810173566301, -77.88316101467591 34.55807965517992, -77.88315280005735 34.55807602511438, -77.883151513443 34.55807223130557, -77.88315138149595 34.55806841020625, -77.88315227226906 34.55806074071715, -77.88315910131105 34.55805771114961, -77.88316715099336 34.55805656484074, -77.8831741780788 34.55802580501214, -77.88317995141169 34.5580256685587, -77.88318457007797 34.55802555939574, -77.88319261975674 34.55802441308536, -77.88319816217881 34.55801758970745, -77.88322234419883 34.55801510604694, -77.8832237957529 34.55802367622881, -77.88331435456389 34.55803587660795, -77.88331409065532 34.55802823441038, -77.88344077404227 34.55804914138374, -77.883439223465 34.55810462918924, -77.88341768064025 34.55815007295751))"}, {"properties": {"feature_type": "building", "subtype": "un-classified", "uid": "f439a30e-7116-49e9-8ef6-e15aac406f5e"}, "wkt": "POLYGON ((-77.88311156221188 34.55818694767936, -77.88316721647628 34.55819232302587, -77.88316461001281 34.55825070395105, -77.88314227518896 34.55830668299252, -77.88311559118648 34.55830363289896, -77.88311156221188 34.55818694767936))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "a3f43001-8735-4821-a6a0-49022e9f20fb"}, "wkt": "POLYGON ((-77.8846910679991 34.55682517956887, -77.88470950100854 34.55675670540426, -77.88479029768439 34.55676736658847, -77.88479692330704 34.55677398736153, -77.88484731441972 34.55678057726332, -77.88485053661914 34.55678309491758, -77.88483411359746 34.55685222043633, -77.88473798550865 34.55683763361691, -77.88473780642686 34.5568324501429, -77.8846910679991 34.55682517956887))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "82418833-2ea8-41a5-9246-d60d8bfdb23a"}, "wkt": "POLYGON ((-77.88487291865903 34.55715867448387, -77.88487573791652 34.55714952932209, -77.88485841869129 34.55714734504554, -77.8848734992645 34.55708473590789, -77.88488764103705 34.55708569839874, -77.88489359295717 34.55707647915258, -77.88520435464862 34.55713267899869, -77.88520296833045 34.55718329193905, -77.8851987618865 34.55719765762435, -77.88518104053765 34.55722920300632, -77.88500766900209 34.55720217710186, -77.88501183070433 34.55718651555339, -77.88487144187052 34.5571613032623, -77.88487291865903 34.55715867448387))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "ab86ca08-72bd-4a51-add8-88f5866ce1b2"}, "wkt": "POLYGON ((-77.88306564963939 34.55685724989323, -77.8831038141072 34.55685854781834, -77.88310047499864 34.55688501678473, -77.88314321368593 34.55689104403149, -77.88313781049365 34.55691932111869, -77.88309725728585 34.55691500155517, -77.88309397281267 34.55693091321036, -77.88306809323188 34.55692802004084, -77.88306564963939 34.55685724989323))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "af9e5189-1ebe-4a2c-9676-0957af86a96b"}, "wkt": "POLYGON ((-77.88395244330832 34.55849902372572, -77.88396950231545 34.55843880300438, -77.88400993485114 34.55843960643708, -77.88403616150113 34.55846009841055, -77.88401236370728 34.55850992244488, -77.88395244330832 34.55849902372572))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "c405812e-028e-4850-9121-9e633cbcec94"}, "wkt": "POLYGON ((-77.88396258209686 34.55854628609416, -77.88396786363089 34.5585144931852, -77.88401283157907 34.55852264832444, -77.88400199596489 34.55855495719027, -77.88396258209686 34.55854628609416))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "5cadf7a7-2475-4351-8b03-55002ae148b7"}, "wkt": "POLYGON ((-77.88400440566956 34.55855551820228, -77.88401523843896 34.55852312700588, -77.8840534642232 34.5585300627629, -77.88404186893763 34.5585637642828, -77.88400440566956 34.55855551820228))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "fb969c17-8394-4880-80ad-df8e12b2fe2d"}, "wkt": "POLYGON ((-77.88354280939843 34.55700394218257, -77.88351987628955 34.55707989514696, -77.88347799845675 34.55707595161115, -77.88341908541429 34.55707027480654, -77.88342053541473 34.55706341309831, -77.88340245240715 34.55706163168451, -77.88345678659772 34.55687716236026, -77.8836224063085 34.55689141105609, -77.8836137243662 34.55693601708, -77.88362107841132 34.55697298567615, -77.88359847622966 34.55701249317154, -77.88354280939843 34.55700394218257))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "55b37267-1efa-4467-8859-2648ca217719"}, "wkt": "POLYGON ((-77.88322728849606 34.55681360205389, -77.88321493417244 34.55685054233133, -77.88318492425799 34.5568449086422, -77.88313871773764 34.55683895296965, -77.88312329935505 34.55683649827485, -77.88314175807673 34.5567543081529, -77.88322899104418 34.55676422758852, -77.88327449225437 34.55677442854596, -77.88326410778573 34.55681907479028, -77.88322728849606 34.55681360205389))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "32030f12-6b26-43a3-9356-d95faecfc421"}, "wkt": "POLYGON ((-77.88330722215647 34.5567639284922, -77.88324995043419 34.5567582343953, -77.88326021332266 34.55671006715222, -77.88331573403403 34.55671439308254, -77.88330722215647 34.5567639284922))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "615959de-e5ec-4cd7-8600-b259704399b4"}, "wkt": "POLYGON ((-77.88330417462282 34.55664508520859, -77.88332964968863 34.55654213583967, -77.88330821386509 34.55653744026395, -77.88332467703755 34.55647213961867, -77.88336152145696 34.55647545087609, -77.8833643769902 34.55646369000073, -77.88345507014395 34.55647683767227, -77.8834015601375 34.55665890013624, -77.88330417462282 34.55664508520859))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "335b572c-34e6-42bf-a95e-cfec4d023508"}, "wkt": "POLYGON ((-77.88362038654232 34.55655972977387, -77.88358398077862 34.55666489697758, -77.88350080920027 34.55664924359749, -77.8835066215094 34.55662021045116, -77.88348685003261 34.55661503959888, -77.88349832871772 34.55657741521997, -77.88351980252689 34.55658254583178, -77.8835370934717 34.55654055541468, -77.88362038654232 34.55655972977387))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "a3d242c8-2a6d-4840-897c-2703e794a99c"}, "wkt": "POLYGON ((-77.88390461979337 34.55641451998434, -77.88386481945039 34.55654091043001, -77.883677556706 34.55650943195434, -77.88372033888307 34.55638214024328, -77.88390461979337 34.55641451998434))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "1fef6386-74d2-4fc9-b36c-4395882bd7c2"}, "wkt": "POLYGON ((-77.88372787055177 34.55676113933983, -77.88359026746532 34.5567371075315, -77.88361419783486 34.55664299481805, -77.88386703443392 34.55669188686669, -77.88383322147249 34.55680234489709, -77.88372103689836 34.55678526321648, -77.88372787055177 34.55676113933983))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "3d6abae2-d72a-4f7b-8df7-8f9fb621c1e2"}, "wkt": "POLYGON ((-77.88370323107738 34.5567641479819, -77.88369805112087 34.55678682321652, -77.88362280747043 34.55677873503534, -77.88362706331614 34.55675396732426, -77.88370323107738 34.5567641479819))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "07d78565-6c55-4e2f-9426-6bb5df716ebc"}, "wkt": "POLYGON ((-77.88473659293558 34.55670838886432, -77.88456712087751 34.55668564919492, -77.8845888515598 34.55658629923183, -77.88475937508976 34.55661284954349, -77.88473659293558 34.55670838886432))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "5e8de23b-248c-4a31-82d7-cf461ed646cf"}, "wkt": "POLYGON ((-77.8847232030401 34.55703274098161, -77.88466359959821 34.55702697172166, -77.88467051606126 34.55699533224834, -77.88472884283428 34.5570027883229, -77.8847232030401 34.55703274098161))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "d04d36f5-658d-4b62-9531-adcdfd37862f"}, "wkt": "POLYGON ((-77.88492474387733 34.55693520375194, -77.88487508705309 34.5569275427375, -77.88488167965608 34.55690585067649, -77.88492996450778 34.55691243971643, -77.88492474387733 34.55693520375194))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "9cd50dd1-0f9d-47fd-8d67-f5ee1a612f27"}, "wkt": "POLYGON ((-77.88630180466907 34.55762741431437, -77.88627697514096 34.55766398139208, -77.88623321170748 34.55768750409602, -77.8861460846488 34.55762030477376, -77.88621678817657 34.5575583661248, -77.88630180466907 34.55762741431437))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "d87db64b-2242-49d8-9049-11b369a6be0f"}, "wkt": "POLYGON ((-77.88773636053371 34.55839125884264, -77.88767979410832 34.55844081398382, -77.88762615928971 34.558494891711, -77.88749277430071 34.5584096529585, -77.88761020190989 34.55830774268784, -77.88773636053371 34.55839125884264))"}], "xy": [{"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "0c170af0-8c1d-4482-8b78-c2f9467b6e08"}, "wkt": "POLYGON ((55.61690898199771 48.80097776734608, 63.50690050125556 41.375103395918, 64.66719337153614 35.34158047218917, 75.34188778071544 27.21953037894912, 89.72951937509823 42.07127911365463, 89.03334365366854 42.76745483954193, 96.69127659716374 50.19332921198885, 96.45921802471229 51.58568065663162, 101.5645066545581 56.92302785549198, 93.67451513402672 64.34890222692006, 102.4927409518778 70.84654230090081, 102.9568580981816 75.25565521046448, 92.2821636920588 83.60976387526459, 91.121870822415 83.8418224488623, 87.87305078300591 83.8418224519188, 77.19835637369924 72.00683517194587, 77.66247352509721 69.68624943189342, 75.80600492867485 70.15036658010767, 66.52366196668495 61.56419934170986, 67.68395483505523 61.10008218942028, 55.61690898199771 48.80097776734608))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "0de0d6bb-53a2-4613-9c25-00cb789087cf"}, "wkt": "POLYGON ((859.5006231457929 129.9332079186898, 888.0438277575223 138.0552580119299, 882.9385391297142 159.4046468257103, 881.0820705352021 159.4046468257103, 853.6991587915883 152.2108310278799, 854.3953345137821 140.6079023276177, 859.5006231457929 129.9332079186898))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "07200cae-a9a0-4cdd-a410-3b5a0dc60fb8"}, "wkt": "POLYGON ((856.2518031074027 177.9693327522428, 869.2470832556149 180.754035643566, 869.0150246857105 182.1463870861711, 871.5676689969401 182.6105042333666, 870.1753175533166 189.8043200291593, 869.9432589812473 191.6607886230351, 872.2638447200254 192.3569643448471, 871.7997275718113 193.0531400676779, 872.9600204460399 193.2851986412756, 870.8714932764019 206.2804787912748, 868.0867903864805 207.4407716602821, 867.1585560934908 208.3690059577295, 865.3020874970684 209.7613574044099, 863.4456189044668 210.9216502764738, 861.1250331636509 211.6178259942104, 860.1967988668406 212.3140017170412, 859.7326817178623 213.2422360124509, 859.5006231459204 215.0987046042891, 837.687117179475 211.1537088490527, 838.383292901032 208.8331231100191, 837.9191757549829 205.8163616420417, 837.2230000313882 203.4957759040269, 836.9909414593188 201.4072487375722, 836.7588828844476 200.9431315903767, 839.3115271988611 185.8593242718852, 854.3953345137821 188.6440271601519, 856.2518031074027 177.9693327522428))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "4f1f4610-8d56-476f-8b2b-5bb99bc22c4f"}, "wkt": "POLYGON ((960.6781614527763 206.0484202095264, 1008.946344863478 217.4192903372097, 1009.17840344217 219.043700356469, 1012.659282053903 219.2757589310856, 1011.731047754291 224.6131061350401, 1013.35545777304 225.5413404324875, 1013.587516346129 226.4695747248406, 1013.587516349822 227.3978090243257, 1013.355457771385 229.2542776141262, 1011.963106327761 229.950453336957, 1010.338696310286 230.1825119105547, 1008.714286289881 237.6083862809639, 1007.553993418963 237.6083862799451, 1006.625759125591 237.6083862799451, 1005.001349107097 237.8404448535428, 1003.841056234396 239.4648548778963, 998.9678261775115 239.9289720240729, 998.7357676060789 237.8404448545616, 980.6351988249643 234.3595662475395, 980.6351988236908 236.2160348414153, 955.3408142479319 230.4145704902654, 956.0369899703804 216.955173192052, 960.6781614527763 206.0484202095264))"}, {"properties": {"feature_type": "building", "subtype": "un-classified", "uid": "f439a30e-7116-49e9-8ef6-e15aac406f5e"}, "wkt": "POLYGON ((1022.405603040438 198.8542030530328, 1011.266930606077 197.230194390399, 1012.195164905307 183.0746213734301, 1017.068394958117 169.6152240762356, 1022.405658484 170.5086387786512, 1022.405603040438 198.8542030530328))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "a3f43001-8735-4821-a6a0-49022e9f20fb"}, "wkt": "POLYGON ((695.776855675697 520.326189212133, 691.6001992422629 536.8408029389985, 675.4490785881894 533.7892998044086, 674.1644969568986 532.1442394529972, 664.0909893935494 530.2554567848209, 663.4613951714609 529.6258625641332, 667.2389605069209 512.9416156608903, 686.4415843023331 517.0339781096245, 686.441584301569 518.2931665530376, 695.776855675697 520.326189212133))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "82418833-2ea8-41a5-9246-d60d8bfdb23a"}, "wkt": "POLYGON ((661.572612506087 438.3347002740391, 660.9430182794138 440.538280054597, 664.4057865052941 441.1678742763036, 660.9430182785223 456.2781356166199, 658.1098442775323 455.9633385093325, 656.8506558345015 458.1669182909092, 594.8356248914804 442.7418598371925, 595.4652191177715 430.464772497103, 596.4096104482935 427.0020042700755, 600.1871757861732 419.4468735943137, 634.8148580370804 427.0020042649813, 633.8704667043934 430.7795696064281, 661.8874096138837 437.7051060543702, 661.572612506087 438.3347002740391))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "ab86ca08-72bd-4a51-add8-88f5866ce1b2"}, "wkt": "POLYGON ((1022.40530105788 521.8688059098862, 1014.750362274312 521.3348336587014, 1015.604433034096 514.929302963945, 1007.06372543676 513.2211614461585, 1008.344831575482 506.3885953668612, 1016.45850379197 507.6697015052012, 1017.228399262888 503.8263830850872, 1022.405301851677 504.6770882528151, 1022.40530105788 521.8688059098862))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "af9e5189-1ebe-4a2c-9676-0957af86a96b"}, "wkt": "POLYGON ((855.7126638310727 118.2808324342647, 851.8693454101957 132.8000353446206, 843.7556731956175 132.3729999641551, 838.6312486384386 127.2485754087575, 843.7556731971458 115.2915847740628, 855.7126638310727 118.2808324342647))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "c405812e-028e-4850-9121-9e633cbcec94"}, "wkt": "POLYGON ((854.0045223112489 106.7508771790167, 852.7234161720179 114.4375140110942, 843.7499916069698 112.2000063732738, 846.1499916062384 104.4200063649448, 854.0045223112489 106.7508771790167))"}, {"properties": {"feature_type": "building", "subtype": "no-damage", "uid": "5cadf7a7-2475-4351-8b03-55002ae148b7"}, "wkt": "POLYGON ((845.6699916056206 104.270006368811, 843.2699916101726 112.0700063674551, 835.6420009793837 110.1671602166276, 838.2042132583553 102.0534879989904, 845.6699916056206 104.270006368811))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "fb969c17-8394-4880-80ad-df8e12b2fe2d"}, "wkt": "POLYGON ((927.6025028366421 483.5254130618658, 932.7345005525124 465.2212878692918, 941.1167634896012 466.4187540022523, 952.907898207941 468.134660304339, 952.5691354782165 469.7918511737246, 956.1880845257092 470.3279917733911, 943.9978224908103 514.7916256273054, 910.8379769582616 510.3828677796618, 912.8907760443551 499.6056725748663, 911.6703690809596 490.5902653289529, 916.4831744489665 481.1304807939071, 927.6025028366421 483.5254130618658))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "55b37267-1efa-4467-8859-2648ca217719"}, "wkt": "POLYGON ((989.643381621177 531.5359656410736, 992.3804470722731 522.6405029329682, 998.3677777425502 524.180102243718, 1007.605373632772 525.8907681540603, 1010.684572263186 526.5750345126957, 1006.40790749943 546.418759019076, 988.9591152626693 543.510626982905, 979.8925859598136 540.7735615351193, 982.2875182259887 529.9963663262484, 989.643381621177 531.5359656410736))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "32030f12-6b26-43a3-9356-d95faecfc421"}, "wkt": "POLYGON ((973.2471631868183 543.1344190037569, 984.7086247557218 544.8450849069674, 982.3136924910749 556.4776130659151, 971.1943641017438 555.1090803455882, 973.2471631868183 543.1344190037569))"}, {"properties": {"feature_type": "building", "subtype": "minor-damage", "uid": "615959de-e5ec-4cd7-8600-b259704399b4"}, "wkt": "POLYGON ((973.0350487516769 571.9981667861731, 967.2054082272982 596.8404256839333, 971.477465844637 598.1031379563605, 967.718607995383 613.8588028898241, 960.3426799360823 612.8436987164754, 959.6876925281534 615.681977473385, 941.5663742784617 611.9703821718908, 953.5744767300724 568.0862259376914, 973.0350487516769 571.9981667861731))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "335b572c-34e6-42bf-a95e-cfec4d023508"}, "wkt": "POLYGON ((908.9433248750539 590.9018822522343, 916.9834546325706 565.5840268472259, 933.5769139209101 569.8606916128933, 932.2083811931971 576.8744218283842, 936.1429127805645 578.2429545507489, 933.5769139181084 587.3094838533527, 929.3002491547345 585.9409511258939, 925.5367841636482 596.0338799679788, 908.9433248750539 590.9018822522343))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "a3d242c8-2a6d-4840-897c-2703e794a99c"}, "wkt": "POLYGON ((850.8581088066478 624.517067059264, 859.7271988804068 594.067291286196, 897.1139175450558 602.7824099424439, 887.6398362356009 633.4338494629513, 850.8581088066478 624.517067059264))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "1fef6386-74d2-4fc9-b36c-4395882bd7c2"}, "wkt": "POLYGON ((888.755857585394 541.3979782066368, 916.2217832877445 548.0206313057095, 910.7635549005214 570.7268613997027, 860.3295245931605 557.4087841332491, 867.8857335345721 530.7918495902267, 890.2954569039121 535.5817141251254, 888.755857585394 541.3979782066368))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "3d6abae2-d72a-4f7b-8df7-8f9fb621c1e2"}, "wkt": "POLYGON ((893.7246680438199 540.8090816127841, 894.9221341770348 535.3349507100808, 909.9759941454555 537.7298829831337, 908.9495946031728 543.717213649974, 893.7246680438199 540.8090816127841))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "07d78565-6c55-4e2f-9426-6bb5df716ebc"}, "wkt": "POLYGON ((685.8245556063549 548.4129488041945, 719.6991479022705 554.9051585965298, 714.6460896057362 578.8951874091802, 680.5867444669218 571.4719968021163, 685.8245556063549 548.4129488041945))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "5e8de23b-248c-4a31-82d7-cf461ed646cf"}, "wkt": "POLYGON ((690.7637233384668 469.7613235764416, 702.6928516812962 471.5037805253575, 701.0844298816606 479.1437840695855, 689.4233718391738 476.9992216719385, 690.7637233384668 469.7613235764416))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "d04d36f5-658d-4b62-9531-adcdfd37862f"}, "wkt": "POLYGON ((649.6149323116601 492.2792287654887, 659.5335334051043 494.4237911651733, 658.0591467557673 499.6511620098834, 648.4086159625384 497.7746699130885, 649.6149323116601 492.2792287654887))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "9cd50dd1-0f9d-47fd-8d67-f5ee1a612f27"}, "wkt": "POLYGON ((377.887746217833 316.3555277102174, 383.1276454695468 307.6223622878049, 392.0791400254283 302.1641338981604, 409.1088125988471 318.9754773358204, 394.4807605164127 333.6035294125284, 377.887746217833 316.3555277102174))"}, {"properties": {"feature_type": "building", "subtype": "major-damage", "uid": "d87db64b-2242-49d8-9049-11b369a6be0f"}, "wkt": "POLYGON ((95.11704523134783 122.7101231855261, 106.8203221391767 111.0068462765475, 117.9663001488766 98.18897156748999, 144.1593484731359 119.6449792297057, 119.8709420542047 143.7065204527901, 95.11704523134783 122.7101231855261))"}]}, "metadata": {"sensor": "GEOEYE01", "provider_asset_type": "GEOEYE01", "gsd": 2.0916247, "capture_date": "2018-09-20T16:04:41.000Z", "off_nadir_angle": 28.017313, "pan_resolution": 0.52282465, "sun_azimuth": 153.94543, "sun_elevation": 53.722378, "target_azimuth": 190.82309, "disaster": "hurricane-florence", "disaster_type": "flooding", "catalog_id": "1050010012411600", "original_width": 1024, "original_height": 1024, "width": 1024, "height": 1024, "id": "MjU0NjY2MQ.qBUoUBW9X-rXtx0MppJ-rKDiHu4", "img_name": "hurricane-florence_00000048_post_disaster.png"}}"""
TRANSFORMS = transforms.Compose([
    transforms.ToTensor(),
    transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))
])


def min_max(image):
    return (image - image.min()) / (image.max() - image.min())


@app.route("/generate")
def generate():
    # TODO create label_image from parameters
    label_data = json.loads(LABELS_JSON)
    label_data["scene"] = None
    label_image = XView2Dataset.create_label_image(label_data)

    label_tensor = transforms.RandomCrop(
        (HEIGHT, WIDTH)
    )(label_image)
    label_tensor = TRANSFORMS(label_tensor)
    fake_image = generator(label_tensor.unsqueeze(0)).squeeze()

    image_array = min_max(
        np.transpose(
            fake_image.detach().numpy(),
            (1, 2, 0)
        )
    ) * 255
    image_bytes = io.BytesIO()
    Image.fromarray(
        image_array.astype('uint8')
    ).convert(
        'RGB'
    ).save(image_bytes, format='JPEG')
    image_bytes.seek(0)

    return Response(
        FileWrapper(image_bytes),
        mimetype="image/jpeg"
    )


if __name__ == '__main__':
    app.run("0.0.0.0", port=6001)
